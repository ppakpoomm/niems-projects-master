1) Database Schema — Complete (PostgreSQL-oriented)
 Doc ID: DOC-DB-SCHEMA-02
 Version: 1.0 (Canonical)
 SoR: PostgreSQL (public schema)
 DB Contract: db/migrations/0001_init.sql
 Views Contract: VW01–VW10 (MVP10)
 Automation Contract: PM01–PM10
 Validation Gates: A–E


 0. Contract Anchors (copy/paste identical in all docs)
  DB Contract: db/migrations/0001_init.sql  

 Views Contract (MVP10): VW01–VW10  
 Automation Contract (Modules): PM01–PM10  
 Gates: A (DDL) / B (Views) / C (ETL) / D (period_key) / E (evidence coverage)  


 A) Core Primitives (Global conventions)
 A1. Base Columns (applied to all domain tables)
 All tables implement:

 id uuid PRIMARY KEY  
 created_at timestamptz NOT NULL  
 created_by text NOT NULL  
 updated_at timestamptz NOT NULL  
 updated_by text NULL  
 status record_status NOT NULL  
 A2. Keys 

 PK: id (uuid)  
 Natural keys: typically code (text) + uniqueness constraints  
 FK: *_id only (uuid), with explicit constraint names  
 A3. Period Standard

 period_key is canonical join key:  2569-Q1, 2569-01, 2569-H1, 2569-Y    
 Enforced by CHECK constraint (regex)  
 A4. Transition Rules (deprecation-safe)

 Org unit:  Preferred: *_org_unit_id (FK → org_units.id)  
 Legacy: *_org_unit (text) retained during cutover    
 Evidence:  Preferred: evidence_asset_id (FK → evidence_assets.id)  
 Legacy: file_url retained during cutover    
 KPI periods:  Required: period_key  
 Optional display: period_label    


 B) Domain Schemas (by bounded contexts)
 B1. Strategy & Plans (Strategic spine)

 national_policies  
 ems_master_plans (links legal_frameworks)  
 strategic_goals (links master plan + optional national policy)  
 strategic_tactics  
 programs  
 projects  
 B2. Legal & Governance

 legal_frameworks  
 section15_master  
 governance_bodies  
 external_strategies  
 B3. KPI & Performance

 kpis (+ owner_org_unit_id transition)  
 kpi_targets (+ period_key)  
 kpi_performance (+ period_key)  
 sipoc_processes  
 kpi_sipoc_linkages  
 B4. Budget & Finance

 budget_programs  
 budget_allocations (+ org_unit_id transition)  
 project_budget_lines  
 financial_transactions  
 budget_revisions  
 budget_execution_snapshots  
 fund_sources  
 unit_cost_models  
 financial_kpis  
 B5. Evidence & Audit (first-class)

 evidence_assets (NEW)  
 evidence_chain (adds evidence_asset_id, keeps file_url)  
 audit_records  
 B6. Activities, Ops, Risks, Learning

 activity_types  
 activity_instances  
 daily_ops_logs (+ org_unit_id transition)  
 risks  
 lessons_learned  
 recommendations  
 B7. Ecosystem Dimensions & Quality

 stakeholders  
 locations  
 evaluation_frameworks  
 system_lookups  
 data_quality_issues  
 B8. Traceability & Results

 strategic_project_section15_alignment (the gold)  
 result_chains  
 result_chain_edges (NEW)  
 section15_keyword_mapping  
 B9. Org Units (Master, NEW)

 org_units (NEW)  


 C) Index Map (view-driven, MVP)
 Minimum “must-have” indexes aligned to MVP views & operational queries:

 Strategic spine FKs and codes  
 KPI period_key joins  
 Budget execution paths  
 Evidence coverage joins  
 Daily logs by date/org/project  
 Alignment hub (strategic_project_section15_alignment) hot indexes  


 D) Deprecation Notes (Org/Evidence/Period)
 Milestones:

 M1 dual field + dual write  
 M2 backfill ids  
 M3 enforce id NOT NULL for new writes  
 M4 deprecate legacy strings/file_url (or read-only)  


 1) SQL DDL — db/migrations/0001_init.sql

ครบ 40 ตาราง (ตาม schema list) + ตารางเสริมที่จำเป็น: org_units, evidence_assets, result_chain_edges
สำคัญ: ชื่อ constraint/index ตั้งแบบ explicit ตาม Naming Standard


-- db/migrations/0001_init.sql -- NIEMS Strategic System: Canonical PostgreSQL DDL (40 tables + required extensions) -- Contract: Naming Standard (PK/FK/UQ/CK/IX) + Period Key + Org Units + Evidence Assets + Result Chain Edges
BEGIN;
-- Extensions CREATE EXTENSION IF NOT EXISTS pgcrypto;
-- ========================= 
-- ENUM TYPES (contract) 
-- ========================= DO 
BEGIN  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'record_status') THEN    CREATE TYPE record_status AS ENUM ('active','inactive','draft','archived');  END IF;  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'priority_level') THEN    CREATE TYPE priority_level AS ENUM ('high','medium','low');  END IF;  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'budget_type') THEN    CREATE TYPE budget_type AS ENUM ('personnel','operating','investment','other');  END IF;  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'stakeholder_type') THEN    CREATE TYPE stakeholder_type AS ENUM ('internal','external','community','private','academic','other');  END IF;  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'location_type') THEN    CREATE TYPE location_type AS ENUM ('province','health_region','airport','hospital','other');  END IF;  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'kpi_type') THEN    CREATE TYPE kpi_type AS ENUM ('input','process','output','outcome','impact');  END IF;  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'data_source_type') THEN    CREATE TYPE data_source_type AS ENUM ('system','daily_log','survey','mixed');  END IF;  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'sipoc_category') THEN    CREATE TYPE sipoc_category AS ENUM ('S','I','P','O','C');  END IF;  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'period_type') THEN    CREATE TYPE period_type AS ENUM ('annual','quarterly','monthly');  END IF;  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'transaction_type') THEN    CREATE TYPE transaction_type AS ENUM ('disbursement','commitment','adjustment');  END IF;  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'revision_round') THEN    CREATE TYPE revision_round AS ENUM ('initial','mid_year','end_year');  END IF;  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'confidence_level') THEN    CREATE TYPE confidence_level AS ENUM ('low','medium','high');  END IF;  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'result_level') THEN    CREATE TYPE result_level AS ENUM ('input','process','output','outcome','impact');  END IF;  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'evidence_classification') THEN    CREATE TYPE evidence_classification AS ENUM ('public','internal','confidential','restricted');  END IF;  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'etl_run_status') THEN    CREATE TYPE etl_run_status AS ENUM ('started','validated','loaded','failed','cancelled');  END IF;END

;
-- ========================= 
-- CORE FUNCTIONS / TRIGGERS 
-- ========================= 
CREATE OR REPLACE FUNCTION fn_set_updated_at() RETURNS trigger LANGUAGE plpgsql AS 
BEGIN  NEW.updated_at = now();  RETURN NEW;END;

;
-- ========================= 
-- MASTER TABLES (required additions) 
-- =========================
-- org_units (NEW) CREATE TABLE IF NOT EXISTS org_units (  id uuid NOT NULL DEFAULT gen_random_uuid(),  code text NOT NULL,  name_th text NOT NULL,  name_en text NULL,  parent_org_unit_id uuid NULL,  created_at timestamptz NOT NULL DEFAULT now(),  created_by text NOT NULL,  updated_at timestamptz NOT NULL DEFAULT now(),  updated_by text NULL,  status record_status NOT NULL DEFAULT 'active',  CONSTRAINT pk_org_units PRIMARY KEY (id),  CONSTRAINT uq_org_unitscode UNIQUE (code),  CONSTRAINT ck_org_unitsno_self_parent CHECK (parent_org_unit_id IS NULL OR parent_org_unit_id <> id),  CONSTRAINT fk_org_unitsorg_unitsparent_org_unit_id    FOREIGN KEY (parent_org_unit_id) REFERENCES org_units(id) );
CREATE INDEX IF NOT EXISTS ix_org_unitscode ON org_units (code); CREATE INDEX IF NOT EXISTS ix_org_unitsparent_org_unit_id ON org_units (parent_org_unit_id);
-- legal_frameworks (list 5) CREATE TABLE IF NOT EXISTS legal_frameworks (  id uuid NOT NULL DEFAULT gen_random_uuid(),  law_code text NOT NULL,  name_th text NOT NULL,  section text NULL,  description text NULL,  effective_date date NULL,  reference_url text NULL,  created_at timestamptz NOT NULL DEFAULT now(),  created_by text NOT NULL,  updated_at timestamptz NOT NULL DEFAULT now(),  updated_by text NULL,  status record_status NOT NULL DEFAULT 'active',  CONSTRAINT pk_legal_frameworks PRIMARY KEY (id),  CONSTRAINT uq_legal_frameworks__law_code UNIQUE (law_code) );
CREATE INDEX IF NOT EXISTS ix_legal_frameworks__law_code ON legal_frameworks (law_code);
-- section15_master (list 6) CREATE TABLE IF NOT EXISTS section15_master (  id uuid NOT NULL DEFAULT gen_random_uuid(),  number integer NOT NULL,  name_th text NOT NULL,  description text NULL,  law_id uuid NOT NULL,  created_at timestamptz NOT NULL DEFAULT now(),  created_by text NOT NULL,  updated_at timestamptz NOT NULL DEFAULT now(),  updated_by text NULL,  status record_status NOT NULL DEFAULT 'active',  CONSTRAINT pk_section15_master PRIMARY KEY (id),  CONSTRAINT uq_section15_masterlaw_id_number UNIQUE (law_id, number),  CONSTRAINT ck_section15_masternumber_1_99 CHECK (number BETWEEN 1 AND 99),  CONSTRAINT fk_section15_masterlegal_frameworkslaw_id    FOREIGN KEY (law_id) REFERENCES legal_frameworks(id) );
CREATE INDEX IF NOT EXISTS ix_section15_masterlaw_id ON section15_master (law_id); CREATE INDEX IF NOT EXISTS ix_section15_masterlaw_id_number ON section15_master (law_id, number);
-- national_policies (list 1) CREATE TABLE IF NOT EXISTS national_policies (  id uuid NOT NULL DEFAULT gen_random_uuid(),  code text NOT NULL,  name_th text NOT NULL,  name_en text NULL,  description text NULL,  issuing_agency text NULL,  start_year integer NULL,  end_year integer NULL,  created_at timestamptz NOT NULL DEFAULT now(),  created_by text NOT NULL,  updated_at timestamptz NOT NULL DEFAULT now(),  updated_by text NULL,  status record_status NOT NULL DEFAULT 'active',  CONSTRAINT pk_national_policies PRIMARY KEY (id),  CONSTRAINT uq_national_policiescode UNIQUE (code),  CONSTRAINT ck_national_policiesyear_range CHECK (    start_year IS NULL OR end_year IS NULL OR start_year <= end_year  ) );
CREATE INDEX IF NOT EXISTS ix_national_policies__code ON national_policies (code);
-- ems_master_plans (list 2) CREATE TABLE IF NOT EXISTS ems_master_plans (  id uuid NOT NULL DEFAULT gen_random_uuid(),  code text NOT NULL,  name_th text NOT NULL,  period_start integer NOT NULL,  period_end integer NOT NULL,  legal_basis_id uuid NULL,  document_url text NULL,  created_at timestamptz NOT NULL DEFAULT now(),  created_by text NOT NULL,  updated_at timestamptz NOT NULL DEFAULT now(),  updated_by text NULL,  status record_status NOT NULL DEFAULT 'active',  CONSTRAINT pk_ems_master_plans PRIMARY KEY (id),  CONSTRAINT uq_ems_master_planscode UNIQUE (code),  CONSTRAINT ck_ems_master_plansperiod_range CHECK (period_start <= period_end),  CONSTRAINT fk_ems_master_planslegal_frameworkslegal_basis_id    FOREIGN KEY (legal_basis_id) REFERENCES legal_frameworks(id) );
CREATE INDEX IF NOT EXISTS ix_ems_master_planscode ON ems_master_plans (code); CREATE INDEX IF NOT EXISTS ix_ems_master_plansperiod_start_period_end ON ems_master_plans (period_start, period_end); CREATE INDEX IF NOT EXISTS ix_ems_master_plans__legal_basis_id ON ems_master_plans (legal_basis_id);
-- strategic_goals (list 3) CREATE TABLE IF NOT EXISTS strategic_goals (  id uuid NOT NULL DEFAULT gen_random_uuid(),  code text NOT NULL,  name_th text NOT NULL,  description text NULL,  master_plan_id uuid NOT NULL,  national_policy_id uuid NULL,  created_at timestamptz NOT NULL DEFAULT now(),  created_by text NOT NULL,  updated_at timestamptz NOT NULL DEFAULT now(),  updated_by text NULL,  status record_status NOT NULL DEFAULT 'active',  CONSTRAINT pk_strategic_goals PRIMARY KEY (id),  CONSTRAINT uq_strategic_goalsmaster_plan_id_code UNIQUE (master_plan_id, code),  CONSTRAINT fk_strategic_goalsems_master_plansmaster_plan_id    FOREIGN KEY (master_plan_id) REFERENCES ems_master_plans(id),  CONSTRAINT fk_strategic_goalsnational_policies__national_policy_id    FOREIGN KEY (national_policy_id) REFERENCES national_policies(id) );
CREATE INDEX IF NOT EXISTS ix_strategic_goalsmaster_plan_id ON strategic_goals (master_plan_id); CREATE INDEX IF NOT EXISTS ix_strategic_goalsnational_policy_id ON strategic_goals (national_policy_id); CREATE INDEX IF NOT EXISTS ix_strategic_goals__code ON strategic_goals (code);
-- strategic_tactics (list 4) CREATE TABLE IF NOT EXISTS strategic_tactics (  id uuid NOT NULL DEFAULT gen_random_uuid(),  code text NOT NULL,  name_th text NOT NULL,  description text NULL,  strategic_goal_id uuid NOT NULL,  priority_level priority_level NULL,  created_at timestamptz NOT NULL DEFAULT now(),  created_by text NOT NULL,  updated_at timestamptz NOT NULL DEFAULT now(),  updated_by text NULL,  status record_status NOT NULL DEFAULT 'active',  CONSTRAINT pk_strategic_tactics PRIMARY KEY (id),  CONSTRAINT uq_strategic_tacticsstrategic_goal_id_code UNIQUE (strategic_goal_id, code),  CONSTRAINT fk_strategic_tacticsstrategic_goals__strategic_goal_id    FOREIGN KEY (strategic_goal_id) REFERENCES strategic_goals(id) );
CREATE INDEX IF NOT EXISTS ix_strategic_tacticsstrategic_goal_id ON strategic_tactics (strategic_goal_id); CREATE INDEX IF NOT EXISTS ix_strategic_tacticscode ON strategic_tactics (code);
-- external_strategies (list 7) CREATE TABLE IF NOT EXISTS external_strategies (  id uuid NOT NULL DEFAULT gen_random_uuid(),  code text NOT NULL,  name_th text NULL,  name_en text NOT NULL,  organization text NOT NULL,  description text NULL,  created_at timestamptz NOT NULL DEFAULT now(),  created_by text NOT NULL,  updated_at timestamptz NOT NULL DEFAULT now(),  updated_by text NULL,  status record_status NOT NULL DEFAULT 'active',  CONSTRAINT pk_external_strategies PRIMARY KEY (id),  CONSTRAINT uq_external_strategies__code UNIQUE (code) );
CREATE INDEX IF NOT EXISTS ix_external_strategies__code ON external_strategies (code);
-- governance_bodies (list 8) CREATE TABLE IF NOT EXISTS governance_bodies (  id uuid NOT NULL DEFAULT gen_random_uuid(),  name_th text NOT NULL,  role text NULL,  legal_basis_id uuid NULL,  scope text NULL,  secretariat_org text NULL,  secretariat_org_unit_id uuid NULL,  created_at timestamptz NOT NULL DEFAULT now(),  created_by text NOT NULL,  updated_at timestamptz NOT NULL DEFAULT now(),  updated_by text NULL,  status record_status NOT NULL DEFAULT 'active',  CONSTRAINT pk_governance_bodies PRIMARY KEY (id),  CONSTRAINT uq_governance_bodiesname_th UNIQUE (name_th),  CONSTRAINT fk_governance_bodieslegal_frameworkslegal_basis_id    FOREIGN KEY (legal_basis_id) REFERENCES legal_frameworks(id),  CONSTRAINT fk_governance_bodiesorg_units__secretariat_org_unit_id    FOREIGN KEY (secretariat_org_unit_id) REFERENCES org_units(id) );
CREATE INDEX IF NOT EXISTS ix_governance_bodieslegal_basis_id ON governance_bodies (legal_basis_id); CREATE INDEX IF NOT EXISTS ix_governance_bodiessecretariat_org_unit_id ON governance_bodies (secretariat_org_unit_id);
-- budget_programs (list 25) CREATE TABLE IF NOT EXISTS budget_programs (  id uuid NOT NULL DEFAULT gen_random_uuid(),  code text NOT NULL,  name_th text NOT NULL,  description text NULL,  law_basis_id uuid NULL,  created_at timestamptz NOT NULL DEFAULT now(),  created_by text NOT NULL,  updated_at timestamptz NOT NULL DEFAULT now(),  updated_by text NULL,  status record_status NOT NULL DEFAULT 'active',  CONSTRAINT pk_budget_programs PRIMARY KEY (id),  CONSTRAINT uq_budget_programscode UNIQUE (code),  CONSTRAINT fk_budget_programslegal_frameworks__law_basis_id    FOREIGN KEY (law_basis_id) REFERENCES legal_frameworks(id) );
CREATE INDEX IF NOT EXISTS ix_budget_programscode ON budget_programs (code); CREATE INDEX IF NOT EXISTS ix_budget_programslaw_basis_id ON budget_programs (law_basis_id);
-- programs (list 9) CREATE TABLE IF NOT EXISTS programs (  id uuid NOT NULL DEFAULT gen_random_uuid(),  code text NOT NULL,  name_th text NOT NULL,  description text NULL,  strategic_tactic_id uuid NOT NULL,  budget_program_id uuid NULL,  created_at timestamptz NOT NULL DEFAULT now(),  created_by text NOT NULL,  updated_at timestamptz NOT NULL DEFAULT now(),  updated_by text NULL,  status record_status NOT NULL DEFAULT 'active',  CONSTRAINT pk_programs PRIMARY KEY (id),  CONSTRAINT uq_programscode UNIQUE (code),  CONSTRAINT fk_programsstrategic_tacticsstrategic_tactic_id    FOREIGN KEY (strategic_tactic_id) REFERENCES strategic_tactics(id),  CONSTRAINT fk_programsbudget_programs__budget_program_id    FOREIGN KEY (budget_program_id) REFERENCES budget_programs(id) );
CREATE INDEX IF NOT EXISTS ix_programsstrategic_tactic_id ON programs (strategic_tactic_id); CREATE INDEX IF NOT EXISTS ix_programsbudget_program_id ON programs (budget_program_id);
-- projects (list 11) + org_unit transition CREATE TABLE IF NOT EXISTS projects (  id uuid NOT NULL DEFAULT gen_random_uuid(),  code text NOT NULL,  name_th text NOT NULL,  description text NULL,  fiscal_year integer NOT NULL,  program_id uuid NOT NULL,  strategic_tactic_id uuid NULL,  owner_org_unit text NOT NULL,              -- legacy (required)  owner_org_unit_id uuid NULL,               -- preferred  section15_coverage_note text NULL,  created_at timestamptz NOT NULL DEFAULT now(),  created_by text NOT NULL,  updated_at timestamptz NOT NULL DEFAULT now(),  updated_by text NULL,  status record_status NOT NULL DEFAULT 'active',  CONSTRAINT pk_projects PRIMARY KEY (id),  CONSTRAINT uq_projectscode UNIQUE (code),  CONSTRAINT ck_projectsfiscal_year_valid CHECK (fiscal_year BETWEEN 2500 AND 3000),  CONSTRAINT fk_projectsprogramsprogram_id    FOREIGN KEY (program_id) REFERENCES programs(id),  CONSTRAINT fk_projectsstrategic_tacticsstrategic_tactic_id    FOREIGN KEY (strategic_tactic_id) REFERENCES strategic_tactics(id),  CONSTRAINT fk_projectsorg_unitsowner_org_unit_id    FOREIGN KEY (owner_org_unit_id) REFERENCES org_units(id) );
CREATE INDEX IF NOT EXISTS ix_projectsprogram_id ON projects (program_id); CREATE INDEX IF NOT EXISTS ix_projectsstrategic_tactic_id ON projects (strategic_tactic_id); CREATE INDEX IF NOT EXISTS ix_projectsfiscal_year ON projects (fiscal_year); CREATE INDEX IF NOT EXISTS ix_projectsowner_org_unit_id ON projects (owner_org_unit_id);
-- fund_sources (list 29) CREATE TABLE IF NOT EXISTS fund_sources (  id uuid NOT NULL DEFAULT gen_random_uuid(),  code text NOT NULL,  name_th text NOT NULL,  description text NULL,  created_at timestamptz NOT NULL DEFAULT now(),  created_by text NOT NULL,  updated_at timestamptz NOT NULL DEFAULT now(),  updated_by text NULL,  status record_status NOT NULL DEFAULT 'active',  CONSTRAINT pk_fund_sources PRIMARY KEY (id),  CONSTRAINT uq_fund_sources__code UNIQUE (code) );
CREATE INDEX IF NOT EXISTS ix_fund_sources__code ON fund_sources (code);
-- project_budget_lines (list 12) CREATE TABLE IF NOT EXISTS project_budget_lines (  id uuid NOT NULL DEFAULT gen_random_uuid(),  project_id uuid NOT NULL,  line_code text NULL,  line_name text NOT NULL,  budget_type budget_type NOT NULL,  approved_amount numeric(18,2) NOT NULL DEFAULT 0,  fund_source_id uuid NULL,  created_at timestamptz NOT NULL DEFAULT now(),  created_by text NOT NULL,  updated_at timestamptz NOT NULL DEFAULT now(),  updated_by text NULL,  status record_status NOT NULL DEFAULT 'active',  CONSTRAINT pk_project_budget_lines PRIMARY KEY (id),  CONSTRAINT uq_project_budget_linesproject_id_line_name UNIQUE (project_id, line_name),  CONSTRAINT ck_project_budget_linesapproved_amount_nonneg CHECK (approved_amount >= 0),  CONSTRAINT fk_project_budget_linesprojectsproject_id    FOREIGN KEY (project_id) REFERENCES projects(id),  CONSTRAINT fk_project_budget_linesfund_sourcesfund_source_id    FOREIGN KEY (fund_source_id) REFERENCES fund_sources(id) );
CREATE INDEX IF NOT EXISTS ix_project_budget_linesproject_id ON project_budget_lines (project_id); CREATE INDEX IF NOT EXISTS ix_project_budget_linesfund_source_id ON project_budget_lines (fund_source_id);
-- budget_allocations (list 26) + org_unit transition CREATE TABLE IF NOT EXISTS budget_allocations (  id uuid NOT NULL DEFAULT gen_random_uuid(),  fiscal_year integer NOT NULL,  org_unit text NOT NULL,         -- legacy  org_unit_id uuid NULL,          -- preferred  budget_program_id uuid NOT NULL,  project_id uuid NULL,  approved_amount numeric(18,2) NOT NULL DEFAULT 0,  created_at timestamptz NOT NULL DEFAULT now(),  created_by text NOT NULL,  updated_at timestamptz NOT NULL DEFAULT now(),  updated_by text NULL,  status record_status NOT NULL DEFAULT 'active',  CONSTRAINT pk_budget_allocations PRIMARY KEY (id),  CONSTRAINT ck_budget_allocationsfiscal_year_valid CHECK (fiscal_year BETWEEN 2500 AND 3000),  CONSTRAINT ck_budget_allocationsapproved_amount_nonneg CHECK (approved_amount >= 0),  CONSTRAINT fk_budget_allocationsbudget_programsbudget_program_id    FOREIGN KEY (budget_program_id) REFERENCES budget_programs(id),  CONSTRAINT fk_budget_allocationsprojectsproject_id    FOREIGN KEY (project_id) REFERENCES projects(id),  CONSTRAINT fk_budget_allocationsorg_unitsorg_unit_id    FOREIGN KEY (org_unit_id) REFERENCES org_units(id) );
CREATE INDEX IF NOT EXISTS ix_budget_allocationsfiscal_year ON budget_allocations (fiscal_year); CREATE INDEX IF NOT EXISTS ix_budget_allocationsbudget_program_id ON budget_allocations (budget_program_id); CREATE INDEX IF NOT EXISTS ix_budget_allocationsproject_id ON budget_allocations (project_id); CREATE INDEX IF NOT EXISTS ix_budget_allocationsorg_unit_id ON budget_allocations (org_unit_id);
-- financial_transactions (list 27) CREATE TABLE IF NOT EXISTS financial_transactions (  id uuid NOT NULL DEFAULT gen_random_uuid(),  project_budget_line_id uuid NOT NULL,  transaction_date date NOT NULL,  amount numeric(18,2) NOT NULL,  transaction_type transaction_type NOT NULL,  document_ref text NULL,  evidence_id uuid NULL,  created_at timestamptz NOT NULL DEFAULT now(),  created_by text NOT NULL,  updated_at timestamptz NOT NULL DEFAULT now(),  updated_by text NULL,  status record_status NOT NULL DEFAULT 'active',  CONSTRAINT pk_financial_transactions PRIMARY KEY (id),  CONSTRAINT ck_financial_transactionsamount_nonneg CHECK (amount >= 0),  CONSTRAINT fk_financial_transactionsproject_budget_linesproject_budget_line_id    FOREIGN KEY (project_budget_line_id) REFERENCES project_budget_lines(id),  CONSTRAINT fk_financial_transactionsevidence_chain__evidence_id    FOREIGN KEY (evidence_id) REFERENCES evidence_chain(id) DEFERRABLE INITIALLY DEFERRED );
CREATE INDEX IF NOT EXISTS ix_financial_transactionsproject_budget_line_id ON financial_transactions (project_budget_line_id); CREATE INDEX IF NOT EXISTS ix_financial_transactionstransaction_date ON financial_transactions (transaction_date);
-- budget_revisions (list 28) CREATE TABLE IF NOT EXISTS budget_revisions (  id uuid NOT NULL DEFAULT gen_random_uuid(),  project_budget_line_id uuid NOT NULL,  revision_round revision_round NOT NULL,  old_amount numeric(18,2) NOT NULL,  new_amount numeric(18,2) NOT NULL,  reason text NULL,  created_at timestamptz NOT NULL DEFAULT now(),  created_by text NOT NULL,  updated_at timestamptz NOT NULL DEFAULT now(),  updated_by text NULL,  status record_status NOT NULL DEFAULT 'active',  CONSTRAINT pk_budget_revisions PRIMARY KEY (id),  CONSTRAINT ck_budget_revisionsamount_nonneg CHECK (old_amount >= 0 AND new_amount >= 0),  CONSTRAINT fk_budget_revisionsproject_budget_lines__project_budget_line_id    FOREIGN KEY (project_budget_line_id) REFERENCES project_budget_lines(id) );
CREATE INDEX IF NOT EXISTS ix_budget_revisions__project_budget_line_id ON budget_revisions (project_budget_line_id);
-- budget_execution_snapshots (list 38) CREATE TABLE IF NOT EXISTS budget_execution_snapshots (  id uuid NOT NULL DEFAULT gen_random_uuid(),  snapshot_date date NOT NULL,  project_id uuid NOT NULL,  budget_line_id uuid NULL,  approved_amount numeric(18,2) NOT NULL DEFAULT 0,  disbursed_amount numeric(18,2) NOT NULL DEFAULT 0,  commitment_amount numeric(18,2) NULL DEFAULT 0,  remaining_amount numeric(18,2) NULL DEFAULT 0,  percent_disbursed numeric(6,2) NULL,  created_at timestamptz NOT NULL DEFAULT now(),  created_by text NOT NULL,  updated_at timestamptz NOT NULL DEFAULT now(),  updated_by text NULL,  status record_status NOT NULL DEFAULT 'active',  CONSTRAINT pk_budget_execution_snapshots PRIMARY KEY (id),  CONSTRAINT ck_budget_execution_snapshotsamount_nonneg CHECK (    approved_amount >= 0 AND disbursed_amount >= 0 AND (commitment_amount IS NULL OR commitment_amount >= 0)  ),  CONSTRAINT fk_budget_execution_snapshotsprojectsproject_id    FOREIGN KEY (project_id) REFERENCES projects(id),  CONSTRAINT fk_budget_execution_snapshotsproject_budget_linesbudget_line_id    FOREIGN KEY (budget_line_id) REFERENCES project_budget_lines(id),  CONSTRAINT uq_budget_execution_snapshotssnapshot_date_project_id_budget_line_id    UNIQUE (snapshot_date, project_id, budget_line_id) );
CREATE INDEX IF NOT EXISTS ix_budget_execution_snapshotsproject_id_snapshot_date ON budget_execution_snapshots (project_id, snapshot_date); CREATE INDEX IF NOT EXISTS ix_budget_execution_snapshotssnapshot_date ON budget_execution_snapshots (snapshot_date);
-- locations (list 16) CREATE TABLE IF NOT EXISTS locations (  id uuid NOT NULL DEFAULT gen_random_uuid(),  code text NOT NULL,  name_th text NOT NULL,  loc_type location_type NOT NULL,  parent_location_id uuid NULL,  latitude numeric(10,6) NULL,  longitude numeric(10,6) NULL,  created_at timestamptz NOT NULL DEFAULT now(),  created_by text NOT NULL,  updated_at timestamptz NOT NULL DEFAULT now(),  updated_by text NULL,  status record_status NOT NULL DEFAULT 'active',  CONSTRAINT pk_locations PRIMARY KEY (id),  CONSTRAINT uq_locationscode UNIQUE (code),  CONSTRAINT fk_locationslocations__parent_location_id    FOREIGN KEY (parent_location_id) REFERENCES locations(id) );
CREATE INDEX IF NOT EXISTS ix_locationscode ON locations (code); CREATE INDEX IF NOT EXISTS ix_locationsparent_location_id ON locations (parent_location_id);
-- activity_types (list 13) CREATE TABLE IF NOT EXISTS activity_types (  id uuid NOT NULL DEFAULT gen_random_uuid(),  code text NOT NULL,  name_th text NOT NULL,  description text NULL,  default_section15_ids jsonb NULL,  created_at timestamptz NOT NULL DEFAULT now(),  created_by text NOT NULL,  updated_at timestamptz NOT NULL DEFAULT now(),  updated_by text NULL,  status record_status NOT NULL DEFAULT 'active',  CONSTRAINT pk_activity_types PRIMARY KEY (id),  CONSTRAINT uq_activity_types__code UNIQUE (code) );
CREATE INDEX IF NOT EXISTS ix_activity_types__code ON activity_types (code);
-- daily_ops_logs (list 35) + org_unit transition CREATE TABLE IF NOT EXISTS daily_ops_logs (  id uuid NOT NULL DEFAULT gen_random_uuid(),  log_date date NOT NULL,  time_from time NULL,  time_to time NULL,  title text NOT NULL,  description text NULL,  activity_type_id uuid NULL,  org_unit text NOT NULL,          -- legacy  org_unit_id uuid NULL,           -- preferred  location_id uuid NULL,  project_id uuid NULL,  kpi_id uuid NULL,  section15_primary_id uuid NULL,  section15_secondary_note text NULL,  linear_issue_id text NULL,  github_event_id text NULL,  created_at timestamptz NOT NULL DEFAULT now(),  created_by text NOT NULL,  updated_at timestamptz NOT NULL DEFAULT now(),  updated_by text NULL,  status record_status NOT NULL DEFAULT 'active',  CONSTRAINT pk_daily_ops_logs PRIMARY KEY (id),  CONSTRAINT fk_daily_ops_logsactivity_typesactivity_type_id    FOREIGN KEY (activity_type_id) REFERENCES activity_types(id),  CONSTRAINT fk_daily_ops_logsorg_unitsorg_unit_id    FOREIGN KEY (org_unit_id) REFERENCES org_units(id),  CONSTRAINT fk_daily_ops_logslocationslocation_id    FOREIGN KEY (location_id) REFERENCES locations(id),  CONSTRAINT fk_daily_ops_logsprojectsproject_id    FOREIGN KEY (project_id) REFERENCES projects(id),  CONSTRAINT fk_daily_ops_logskpiskpi_id    FOREIGN KEY (kpi_id) REFERENCES kpis(id) DEFERRABLE INITIALLY DEFERRED,  CONSTRAINT fk_daily_ops_logssection15_mastersection15_primary_id    FOREIGN KEY (section15_primary_id) REFERENCES section15_master(id) );
CREATE INDEX IF NOT EXISTS ix_daily_ops_logslog_date ON daily_ops_logs (log_date); CREATE INDEX IF NOT EXISTS ix_daily_ops_logsorg_unit_id ON daily_ops_logs (org_unit_id); CREATE INDEX IF NOT EXISTS ix_daily_ops_logsproject_id ON daily_ops_logs (project_id); CREATE INDEX IF NOT EXISTS ix_daily_ops_logskpi_id ON daily_ops_logs (kpi_id); CREATE INDEX IF NOT EXISTS ix_daily_ops_logs__section15_primary_id ON daily_ops_logs (section15_primary_id);
-- activity_instances (list 14) CREATE TABLE IF NOT EXISTS activity_instances (  id uuid NOT NULL DEFAULT gen_random_uuid(),  project_id uuid NOT NULL,  activity_type_id uuid NOT NULL,  name_th text NOT NULL,  description text NULL,  planned_start date NULL,  planned_end date NULL,  actual_start date NULL,  actual_end date NULL,  location_id uuid NULL,  daily_id uuid NULL,  created_at timestamptz NOT NULL DEFAULT now(),  created_by text NOT NULL,  updated_at timestamptz NOT NULL DEFAULT now(),  updated_by text NULL,  status record_status NOT NULL DEFAULT 'active',  CONSTRAINT pk_activity_instances PRIMARY KEY (id),  CONSTRAINT fk_activity_instancesprojectsproject_id    FOREIGN KEY (project_id) REFERENCES projects(id),  CONSTRAINT fk_activity_instancesactivity_typesactivity_type_id    FOREIGN KEY (activity_type_id) REFERENCES activity_types(id),  CONSTRAINT fk_activity_instanceslocationslocation_id    FOREIGN KEY (location_id) REFERENCES locations(id),  CONSTRAINT fk_activity_instancesdaily_ops_logsdaily_id    FOREIGN KEY (daily_id) REFERENCES daily_ops_logs(id),  CONSTRAINT ck_activity_instancesplanned_range_valid CHECK (    planned_start IS NULL OR planned_end IS NULL OR planned_start <= planned_end  ),  CONSTRAINT ck_activity_instancesactual_range_valid CHECK (    actual_start IS NULL OR actual_end IS NULL OR actual_start <= actual_end  ) );
CREATE INDEX IF NOT EXISTS ix_activity_instancesproject_id ON activity_instances (project_id); CREATE INDEX IF NOT EXISTS ix_activity_instancesactivity_type_id ON activity_instances (activity_type_id); CREATE INDEX IF NOT EXISTS ix_activity_instances__planned_start_planned_end ON activity_instances (planned_start, planned_end);
-- stakeholders (list 15) CREATE TABLE IF NOT EXISTS stakeholders (  id uuid NOT NULL DEFAULT gen_random_uuid(),  name_th text NOT NULL,  stakeholder_type stakeholder_type NOT NULL,  role text NULL,  section15_role text NULL,  contact_info text NULL,  created_at timestamptz NOT NULL DEFAULT now(),  created_by text NOT NULL,  updated_at timestamptz NOT NULL DEFAULT now(),  updated_by text NULL,  status record_status NOT NULL DEFAULT 'active',  CONSTRAINT pk_stakeholders PRIMARY KEY (id) );
CREATE INDEX IF NOT EXISTS ix_stakeholders__stakeholder_type ON stakeholders (stakeholder_type);
-- kpis (list 17) + org_unit transition CREATE TABLE IF NOT EXISTS kpis (  id uuid NOT NULL DEFAULT gen_random_uuid(),  code text NOT NULL,  name_th text NOT NULL,  description text NULL,  kpi_type kpi_type NOT NULL,  primary_process_step sipoc_category NULL,  data_source_type data_source_type NOT NULL,  owner_org_unit text NOT NULL,          -- legacy required  owner_org_unit_id uuid NULL,           -- preferred  law_link_id uuid NULL,  created_at timestamptz NOT NULL DEFAULT now(),  created_by text NOT NULL,  updated_at timestamptz NOT NULL DEFAULT now(),  updated_by text NULL,  status record_status NOT NULL DEFAULT 'active',  CONSTRAINT pk_kpis PRIMARY KEY (id),  CONSTRAINT uq_kpiscode UNIQUE (code),  CONSTRAINT fk_kpisorg_unitsowner_org_unit_id    FOREIGN KEY (owner_org_unit_id) REFERENCES org_units(id),  CONSTRAINT fk_kpislegal_frameworks__law_link_id    FOREIGN KEY (law_link_id) REFERENCES legal_frameworks(id) );
CREATE INDEX IF NOT EXISTS ix_kpiscode ON kpis (code); CREATE INDEX IF NOT EXISTS ix_kpiskpi_type ON kpis (kpi_type); CREATE INDEX IF NOT EXISTS ix_kpis__owner_org_unit_id ON kpis (owner_org_unit_id);
-- period_key regex: 4 digits (Thai fiscal) + (Q1-4 | 01-12 | H1-2 | Y) -- Example: 2569-Q1, 2569-01, 2569-H1, 2569-Y -- NOTE: store as text for portability; enforce format via CHECK. -- kpi_targets (list 18) + period_key CREATE TABLE IF NOT EXISTS kpi_targets (  id uuid NOT NULL DEFAULT gen_random_uuid(),  kpi_id uuid NOT NULL,  fiscal_year integer NOT NULL,  period_type period_type NOT NULL,  period_label text NOT NULL,  period_key text NOT NULL,  target_value numeric(18,4) NOT NULL,  unit text NOT NULL,  created_at timestamptz NOT NULL DEFAULT now(),  created_by text NOT NULL,  updated_at timestamptz NOT NULL DEFAULT now(),  updated_by text NULL,  status record_status NOT NULL DEFAULT 'active',  CONSTRAINT pk_kpi_targets PRIMARY KEY (id),  CONSTRAINT uq_kpi_targetskpi_id_fiscal_year_period_key UNIQUE (kpi_id, fiscal_year, period_key),  CONSTRAINT ck_kpi_targetsfiscal_year_valid CHECK (fiscal_year BETWEEN 2500 AND 3000),  CONSTRAINT ck_kpi_targetsperiod_key_fmt CHECK (period_key ~ '^[0-9]{4}-(Q[1-4]|0[1-9]|1[0-2]|H[12]|Y)$'),  CONSTRAINT fk_kpi_targetskpis__kpi_id    FOREIGN KEY (kpi_id) REFERENCES kpis(id) );
CREATE INDEX IF NOT EXISTS ix_kpi_targetskpi_id_period_key ON kpi_targets (kpi_id, period_key); CREATE INDEX IF NOT EXISTS ix_kpi_targetsfiscal_year ON kpi_targets (fiscal_year);
-- kpi_performance (list 19) + period_key CREATE TABLE IF NOT EXISTS kpi_performance (  id uuid NOT NULL DEFAULT gen_random_uuid(),  kpi_id uuid NOT NULL,  period_start date NOT NULL,  period_end date NOT NULL,  period_key text NOT NULL,  reported_value numeric(18,4) NOT NULL,  unit text NOT NULL,  evidence_set_id uuid NULL,  comment text NULL,  created_at timestamptz NOT NULL DEFAULT now(),  created_by text NOT NULL,  updated_at timestamptz NOT NULL DEFAULT now(),  updated_by text NULL,  status record_status NOT NULL DEFAULT 'active',  CONSTRAINT pk_kpi_performance PRIMARY KEY (id),  CONSTRAINT ck_kpi_performanceperiod_range_valid CHECK (period_start <= period_end),  CONSTRAINT ck_kpi_performanceperiod_key_fmt CHECK (period_key ~ '^[0-9]{4}-(Q[1-4]|0[1-9]|1[0-2]|H[12]|Y)$'),  CONSTRAINT fk_kpi_performancekpiskpi_id    FOREIGN KEY (kpi_id) REFERENCES kpis(id),  CONSTRAINT fk_kpi_performanceevidence_chainevidence_set_id    FOREIGN KEY (evidence_set_id) REFERENCES evidence_chain(id) DEFERRABLE INITIALLY DEFERRED );
CREATE INDEX IF NOT EXISTS ix_kpi_performancekpi_id_period_key ON kpi_performance (kpi_id, period_key); CREATE INDEX IF NOT EXISTS ix_kpi_performanceperiod_start_period_end ON kpi_performance (period_start, period_end);
-- sipoc_processes (list 20) CREATE TABLE IF NOT EXISTS sipoc_processes (  id uuid NOT NULL DEFAULT gen_random_uuid(),  name_th text NOT NULL,  category sipoc_category NOT NULL,  description text NULL,  system_source text NULL,  created_at timestamptz NOT NULL DEFAULT now(),  created_by text NOT NULL,  updated_at timestamptz NOT NULL DEFAULT now(),  updated_by text NULL,  status record_status NOT NULL DEFAULT 'active',  CONSTRAINT pk_sipoc_processes PRIMARY KEY (id) );
CREATE INDEX IF NOT EXISTS ix_sipoc_processes__category ON sipoc_processes (category);
-- kpi_sipoc_linkages (list 39) CREATE TABLE IF NOT EXISTS kpi_sipoc_linkages (  id uuid NOT NULL DEFAULT gen_random_uuid(),  kpi_id uuid NOT NULL,  sipoc_id uuid NOT NULL,  process_step sipoc_category NOT NULL,  data_source text NULL,  frequency period_type NOT NULL, -- reuse enum for simplicity (monthly/quarterly/annual)  owner_org_unit text NULL,  owner_org_unit_id uuid NULL,  created_at timestamptz NOT NULL DEFAULT now(),  created_by text NOT NULL,  updated_at timestamptz NOT NULL DEFAULT now(),  updated_by text NULL,  status record_status NOT NULL DEFAULT 'active',  CONSTRAINT pk_kpi_sipoc_linkages PRIMARY KEY (id),  CONSTRAINT uq_kpi_sipoc_linkageskpi_id_sipoc_id_process_step UNIQUE (kpi_id, sipoc_id, process_step),  CONSTRAINT fk_kpi_sipoc_linkageskpiskpi_id    FOREIGN KEY (kpi_id) REFERENCES kpis(id),  CONSTRAINT fk_kpi_sipoc_linkagessipoc_processessipoc_id    FOREIGN KEY (sipoc_id) REFERENCES sipoc_processes(id),  CONSTRAINT fk_kpi_sipoc_linkagesorg_units__owner_org_unit_id    FOREIGN KEY (owner_org_unit_id) REFERENCES org_units(id) );
CREATE INDEX IF NOT EXISTS ix_kpi_sipoc_linkageskpi_id ON kpi_sipoc_linkages (kpi_id); CREATE INDEX IF NOT EXISTS ix_kpi_sipoc_linkagessipoc_id ON kpi_sipoc_linkages (sipoc_id);
-- evaluation_frameworks (list 21) CREATE TABLE IF NOT EXISTS evaluation_frameworks (  id uuid NOT NULL DEFAULT gen_random_uuid(),  name text NOT NULL,  dimension text NOT NULL,  description text NULL,  usage_note text NULL,  created_at timestamptz NOT NULL DEFAULT now(),  created_by text NOT NULL,  updated_at timestamptz NOT NULL DEFAULT now(),  updated_by text NULL,  status record_status NOT NULL DEFAULT 'active',  CONSTRAINT pk_evaluation_frameworks PRIMARY KEY (id) );
CREATE INDEX IF NOT EXISTS ix_evaluation_frameworks__name_dimension ON evaluation_frameworks (name, dimension);
-- risks (list 22) CREATE TABLE IF NOT EXISTS risks (  id uuid NOT NULL DEFAULT gen_random_uuid(),  project_id uuid NULL,  description text NOT NULL,  likelihood integer NOT NULL,  impact integer NOT NULL,  score integer NULL,  mitigation_plan text NULL,  related_daily_id uuid NULL,  created_at timestamptz NOT NULL DEFAULT now(),  created_by text NOT NULL,  updated_at timestamptz NOT NULL DEFAULT now(),  updated_by text NULL,  status record_status NOT NULL DEFAULT 'active',  CONSTRAINT pk_risks PRIMARY KEY (id),  CONSTRAINT ck_riskslikelihood_1_5 CHECK (likelihood BETWEEN 1 AND 5),  CONSTRAINT ck_risksimpact_1_5 CHECK (impact BETWEEN 1 AND 5),  CONSTRAINT fk_risksprojectsproject_id    FOREIGN KEY (project_id) REFERENCES projects(id),  CONSTRAINT fk_risksdaily_ops_logsrelated_daily_id    FOREIGN KEY (related_daily_id) REFERENCES daily_ops_logs(id) );
CREATE INDEX IF NOT EXISTS ix_risksproject_id ON risks (project_id); CREATE INDEX IF NOT EXISTS ix_risksrelated_daily_id ON risks (related_daily_id);
-- lessons_learned (list 23) CREATE TABLE IF NOT EXISTS lessons_learned (  id uuid NOT NULL DEFAULT gen_random_uuid(),  project_id uuid NULL,  kpi_id uuid NULL,  description text NOT NULL,  recommendation text NULL,  evidence_id uuid NULL,  created_at timestamptz NOT NULL DEFAULT now(),  created_by text NOT NULL,  updated_at timestamptz NOT NULL DEFAULT now(),  updated_by text NULL,  status record_status NOT NULL DEFAULT 'active',  CONSTRAINT pk_lessons_learned PRIMARY KEY (id),  CONSTRAINT fk_lessons_learnedprojectsproject_id    FOREIGN KEY (project_id) REFERENCES projects(id),  CONSTRAINT fk_lessons_learnedkpiskpi_id    FOREIGN KEY (kpi_id) REFERENCES kpis(id),  CONSTRAINT fk_lessons_learnedevidence_chainevidence_id    FOREIGN KEY (evidence_id) REFERENCES evidence_chain(id) DEFERRABLE INITIALLY DEFERRED );
CREATE INDEX IF NOT EXISTS ix_lessons_learnedproject_id ON lessons_learned (project_id); CREATE INDEX IF NOT EXISTS ix_lessons_learnedkpi_id ON lessons_learned (kpi_id);
-- recommendations (list 24) CREATE TABLE IF NOT EXISTS recommendations (  id uuid NOT NULL DEFAULT gen_random_uuid(),  title text NOT NULL,  description text NOT NULL,  alignment_id uuid NULL,  priority_level priority_level NOT NULL,  responsible_org text NULL,  responsible_org_unit_id uuid NULL,  created_at timestamptz NOT NULL DEFAULT now(),  created_by text NOT NULL,  updated_at timestamptz NOT NULL DEFAULT now(),  updated_by text NULL,  status record_status NOT NULL DEFAULT 'active',  CONSTRAINT pk_recommendations PRIMARY KEY (id),  CONSTRAINT fk_recommendationsstrategic_project_section15_alignmentalignment_id    FOREIGN KEY (alignment_id) REFERENCES strategic_project_section15_alignment(id) DEFERRABLE INITIALLY DEFERRED,  CONSTRAINT fk_recommendationsorg_unitsresponsible_org_unit_id    FOREIGN KEY (responsible_org_unit_id) REFERENCES org_units(id) );
CREATE INDEX IF NOT EXISTS ix_recommendationsalignment_id ON recommendations (alignment_id); CREATE INDEX IF NOT EXISTS ix_recommendationspriority_level ON recommendations (priority_level);
-- unit_cost_models (list 30) CREATE TABLE IF NOT EXISTS unit_cost_models (  id uuid NOT NULL DEFAULT gen_random_uuid(),  name_th text NOT NULL,  description text NULL,  unit_definition text NOT NULL,  formula text NULL,  created_at timestamptz NOT NULL DEFAULT now(),  created_by text NOT NULL,  updated_at timestamptz NOT NULL DEFAULT now(),  updated_by text NULL,  status record_status NOT NULL DEFAULT 'active',  CONSTRAINT pk_unit_cost_models PRIMARY KEY (id) );
-- financial_kpis (list 31) CREATE TABLE IF NOT EXISTS financial_kpis (  id uuid NOT NULL DEFAULT gen_random_uuid(),  code text NOT NULL,  name_th text NOT NULL,  description text NULL,  calculation text NULL,  created_at timestamptz NOT NULL DEFAULT now(),  created_by text NOT NULL,  updated_at timestamptz NOT NULL DEFAULT now(),  updated_by text NULL,  status record_status NOT NULL DEFAULT 'active',  CONSTRAINT pk_financial_kpis PRIMARY KEY (id),  CONSTRAINT uq_financial_kpis__code UNIQUE (code) );
CREATE INDEX IF NOT EXISTS ix_financial_kpis__code ON financial_kpis (code);
-- audit_records (list 32) CREATE TABLE IF NOT EXISTS audit_records (  id uuid NOT NULL DEFAULT gen_random_uuid(),  project_id uuid NULL,  audit_date date NOT NULL,  auditor_org text NOT NULL,  findings text NULL,  recommendations text NULL,  evidence_id uuid NULL,  created_at timestamptz NOT NULL DEFAULT now(),  created_by text NOT NULL,  updated_at timestamptz NOT NULL DEFAULT now(),  updated_by text NULL,  status record_status NOT NULL DEFAULT 'active',  CONSTRAINT pk_audit_records PRIMARY KEY (id),  CONSTRAINT fk_audit_recordsprojectsproject_id    FOREIGN KEY (project_id) REFERENCES projects(id),  CONSTRAINT fk_audit_recordsevidence_chainevidence_id    FOREIGN KEY (evidence_id) REFERENCES evidence_chain(id) DEFERRABLE INITIALLY DEFERRED );
CREATE INDEX IF NOT EXISTS ix_audit_recordsproject_id ON audit_records (project_id); CREATE INDEX IF NOT EXISTS ix_audit_recordsaudit_date ON audit_records (audit_date);
-- system_lookups (list 34) CREATE TABLE IF NOT EXISTS system_lookups (  id uuid NOT NULL DEFAULT gen_random_uuid(),  category text NOT NULL,  code text NOT NULL,  label_th text NOT NULL,  label_en text NULL,  created_at timestamptz NOT NULL DEFAULT now(),  created_by text NOT NULL,  updated_at timestamptz NOT NULL DEFAULT now(),  updated_by text NULL,  status record_status NOT NULL DEFAULT 'active',  CONSTRAINT pk_system_lookups PRIMARY KEY (id),  CONSTRAINT uq_system_lookups__category_code UNIQUE (category, code) );
CREATE INDEX IF NOT EXISTS ix_system_lookups__category_code ON system_lookups (category, code);
-- data_quality_issues (list 33) CREATE TABLE IF NOT EXISTS data_quality_issues (  id uuid NOT NULL DEFAULT gen_random_uuid(),  system_name text NOT NULL,  kpi_id uuid NULL,  issue_type text NOT NULL,  description text NOT NULL,  daily_id uuid NULL,  resolution_note text NULL,  created_at timestamptz NOT NULL DEFAULT now(),  created_by text NOT NULL,  updated_at timestamptz NOT NULL DEFAULT now(),  updated_by text NULL,  status record_status NOT NULL DEFAULT 'active',  CONSTRAINT pk_data_quality_issues PRIMARY KEY (id),  CONSTRAINT fk_data_quality_issueskpiskpi_id    FOREIGN KEY (kpi_id) REFERENCES kpis(id),  CONSTRAINT fk_data_quality_issuesdaily_ops_logsdaily_id    FOREIGN KEY (daily_id) REFERENCES daily_ops_logs(id) );
CREATE INDEX IF NOT EXISTS ix_data_quality_issuessystem_name ON data_quality_issues (system_name); CREATE INDEX IF NOT EXISTS ix_data_quality_issueskpi_id ON data_quality_issues (kpi_id); CREATE INDEX IF NOT EXISTS ix_data_quality_issues__daily_id ON data_quality_issues (daily_id);
-- result_chains (list 10) CREATE TABLE IF NOT EXISTS result_chains (  id uuid NOT NULL DEFAULT gen_random_uuid(),  name_th text NOT NULL,  level result_level NOT NULL,  description text NULL,  strategic_goal_id uuid NULL,  program_id uuid NULL,  created_at timestamptz NOT NULL DEFAULT now(),  created_by text NOT NULL,  updated_at timestamptz NOT NULL DEFAULT now(),  updated_by text NULL,  status record_status NOT NULL DEFAULT 'active',  CONSTRAINT pk_result_chains PRIMARY KEY (id),  CONSTRAINT fk_result_chainsstrategic_goalsstrategic_goal_id    FOREIGN KEY (strategic_goal_id) REFERENCES strategic_goals(id),  CONSTRAINT fk_result_chainsprogramsprogram_id    FOREIGN KEY (program_id) REFERENCES programs(id) );
CREATE INDEX IF NOT EXISTS ix_result_chainsstrategic_goal_id ON result_chains (strategic_goal_id); CREATE INDEX IF NOT EXISTS ix_result_chainsprogram_id ON result_chains (program_id); CREATE INDEX IF NOT EXISTS ix_result_chains__level ON result_chains (level);
-- result_chain_edges (NEW: make result chains executable) CREATE TABLE IF NOT EXISTS result_chain_edges (  id uuid NOT NULL DEFAULT gen_random_uuid(),  parent_node_id uuid NOT NULL,  child_node_id uuid NOT NULL,  weight integer NULL,  note text NULL,  created_at timestamptz NOT NULL DEFAULT now(),  created_by text NOT NULL,  updated_at timestamptz NOT NULL DEFAULT now(),  updated_by text NULL,  status record_status NOT NULL DEFAULT 'active',  CONSTRAINT pk_result_chain_edges PRIMARY KEY (id),  CONSTRAINT ck_result_chain_edgesno_self_edge CHECK (parent_node_id <> child_node_id),  CONSTRAINT uq_result_chain_edgesparent_child UNIQUE (parent_node_id, child_node_id),  CONSTRAINT fk_result_chain_edgesresult_chainsparent_node_id    FOREIGN KEY (parent_node_id) REFERENCES result_chains(id),  CONSTRAINT fk_result_chain_edgesresult_chainschild_node_id    FOREIGN KEY (child_node_id) REFERENCES result_chains(id),  CONSTRAINT ck_result_chain_edges__weight_1_10 CHECK (weight IS NULL OR weight BETWEEN 1 AND 10) );
CREATE INDEX IF NOT EXISTS ix_result_chain_edgesparent_node_id ON result_chain_edges (parent_node_id); CREATE INDEX IF NOT EXISTS ix_result_chain_edgeschild_node_id ON result_chain_edges (child_node_id);
-- section15_keyword_mapping (list 37) CREATE TABLE IF NOT EXISTS section15_keyword_mapping (  id uuid NOT NULL DEFAULT gen_random_uuid(),  keyword text NOT NULL,  section15_id uuid NOT NULL,  weight integer NULL,  note text NULL,  created_at timestamptz NOT NULL DEFAULT now(),  created_by text NOT NULL,  updated_at timestamptz NOT NULL DEFAULT now(),  updated_by text NULL,  status record_status NOT NULL DEFAULT 'active',  CONSTRAINT pk_section15_keyword_mapping PRIMARY KEY (id),  CONSTRAINT uq_section15_keyword_mappingkeyword_section15_id UNIQUE (keyword, section15_id),  CONSTRAINT ck_section15_keyword_mappingweight_1_10 CHECK (weight IS NULL OR weight BETWEEN 1 AND 10),  CONSTRAINT fk_section15_keyword_mappingsection15_mastersection15_id    FOREIGN KEY (section15_id) REFERENCES section15_master(id) );
CREATE INDEX IF NOT EXISTS ix_section15_keyword_mapping__keyword ON section15_keyword_mapping (keyword);
-- strategic_project_section15_alignment (list 40) THE GOLD CREATE TABLE IF NOT EXISTS strategic_project_section15_alignment (  id uuid NOT NULL DEFAULT gen_random_uuid(),  strategic_goal_id uuid NOT NULL,  tactic_id uuid NULL,  project_id uuid NOT NULL,  section15_id uuid NOT NULL,  kpi_id uuid NULL,  weight integer NULL,  note text NULL,  created_at timestamptz NOT NULL DEFAULT now(),  created_by text NOT NULL,  updated_at timestamptz NOT NULL DEFAULT now(),  updated_by text NULL,  status record_status NOT NULL DEFAULT 'active',  CONSTRAINT pk_strategic_project_section15_alignment PRIMARY KEY (id),  CONSTRAINT ck_strategic_project_section15_alignmentweight_1_10 CHECK (weight IS NULL OR weight BETWEEN 1 AND 10),  CONSTRAINT uq_strategic_project_section15_alignmentgoal_project_section15_kpi    UNIQUE (strategic_goal_id, project_id, section15_id, kpi_id),  CONSTRAINT fk_strategic_project_section15_alignmentstrategic_goalsstrategic_goal_id    FOREIGN KEY (strategic_goal_id) REFERENCES strategic_goals(id),  CONSTRAINT fk_strategic_project_section15_alignmentstrategic_tacticstactic_id    FOREIGN KEY (tactic_id) REFERENCES strategic_tactics(id),  CONSTRAINT fk_strategic_project_section15_alignmentprojectsproject_id    FOREIGN KEY (project_id) REFERENCES projects(id),  CONSTRAINT fk_strategic_project_section15_alignmentsection15_mastersection15_id    FOREIGN KEY (section15_id) REFERENCES section15_master(id),  CONSTRAINT fk_strategic_project_section15_alignmentkpiskpi_id    FOREIGN KEY (kpi_id) REFERENCES kpis(id) );
CREATE INDEX IF NOT EXISTS ix_strategic_project_section15_alignmentproject_id  ON strategic_project_section15_alignment (project_id); CREATE INDEX IF NOT EXISTS ix_strategic_project_section15_alignmentstrategic_goal_id  ON strategic_project_section15_alignment (strategic_goal_id); CREATE INDEX IF NOT EXISTS ix_strategic_project_section15_alignmentsection15_id  ON strategic_project_section15_alignment (section15_id); CREATE INDEX IF NOT EXISTS ix_strategic_project_section15_alignmentkpi_id  ON strategic_project_section15_alignment (kpi_id);
-- evidence_assets (NEW: first-class evidence) CREATE TABLE IF NOT EXISTS evidence_assets (  id uuid NOT NULL DEFAULT gen_random_uuid(),  file_url text NOT NULL,  file_type text NULL,  evidence_type text NULL,  checksum_sha256 text NOT NULL,  bytes_size bigint NULL,  mime_type text NULL,  classification evidence_classification NOT NULL DEFAULT 'internal',  retention_until date NULL,  retention_note text NULL,  owner_org_unit_id uuid NULL,  is_personal_data boolean NOT NULL DEFAULT false,  pdpa_note text NULL,  created_at timestamptz NOT NULL DEFAULT now(),  created_by text NOT NULL,  updated_at timestamptz NOT NULL DEFAULT now(),  updated_by text NULL,  status record_status NOT NULL DEFAULT 'active',  CONSTRAINT pk_evidence_assets PRIMARY KEY (id),  CONSTRAINT uq_evidence_assetschecksum_sha256 UNIQUE (checksum_sha256),  CONSTRAINT ck_evidence_assetschecksum_sha256_fmt CHECK (checksum_sha256 ~ '^[0-9a-f]{64}$'),  CONSTRAINT fk_evidence_assetsorg_unitsowner_org_unit_id    FOREIGN KEY (owner_org_unit_id) REFERENCES org_units(id) );
CREATE INDEX IF NOT EXISTS ix_evidence_assetschecksum_sha256 ON evidence_assets (checksum_sha256); CREATE INDEX IF NOT EXISTS ix_evidence_assetsclassification ON evidence_assets (classification); CREATE INDEX IF NOT EXISTS ix_evidence_assets__owner_org_unit_id ON evidence_assets (owner_org_unit_id);
-- evidence_chain (list 36) (now links to evidence_assets; keeps file_url legacy) CREATE TABLE IF NOT EXISTS evidence_chain (  id uuid NOT NULL DEFAULT gen_random_uuid(),  daily_id uuid NULL,  activity_id uuid NULL,  project_id uuid NULL,  kpi_id uuid NULL,  budget_line_id uuid NULL,  section15_id uuid NULL,  evidence_asset_id uuid NULL,  file_url text NOT NULL, -- legacy still required until cutover  file_type text NULL,  evidence_type text NULL,  confidence_level confidence_level NULL,  created_at timestamptz NOT NULL DEFAULT now(),  created_by text NOT NULL,  updated_at timestamptz NOT NULL DEFAULT now(),  updated_by text NULL,  status record_status NOT NULL DEFAULT 'active',  CONSTRAINT pk_evidence_chain PRIMARY KEY (id),  CONSTRAINT fk_evidence_chaindaily_ops_logsdaily_id    FOREIGN KEY (daily_id) REFERENCES daily_ops_logs(id),  CONSTRAINT fk_evidence_chainactivity_instancesactivity_id    FOREIGN KEY (activity_id) REFERENCES activity_instances(id),  CONSTRAINT fk_evidence_chainprojectsproject_id    FOREIGN KEY (project_id) REFERENCES projects(id),  CONSTRAINT fk_evidence_chainkpiskpi_id    FOREIGN KEY (kpi_id) REFERENCES kpis(id),  CONSTRAINT fk_evidence_chainproject_budget_linesbudget_line_id    FOREIGN KEY (budget_line_id) REFERENCES project_budget_lines(id),  CONSTRAINT fk_evidence_chainsection15_mastersection15_id    FOREIGN KEY (section15_id) REFERENCES section15_master(id),  CONSTRAINT fk_evidence_chainevidence_assetsevidence_asset_id    FOREIGN KEY (evidence_asset_id) REFERENCES evidence_assets(id) );
CREATE INDEX IF NOT EXISTS ix_evidence_chainproject_id ON evidence_chain (project_id); CREATE INDEX IF NOT EXISTS ix_evidence_chainkpi_id ON evidence_chain (kpi_id); CREATE INDEX IF NOT EXISTS ix_evidence_chainbudget_line_id ON evidence_chain (budget_line_id); CREATE INDEX IF NOT EXISTS ix_evidence_chainsection15_id ON evidence_chain (section15_id); CREATE INDEX IF NOT EXISTS ix_evidence_chaindaily_id ON evidence_chain (daily_id); CREATE INDEX IF NOT EXISTS ix_evidence_chainactivity_id ON evidence_chain (activity_id); CREATE INDEX IF NOT EXISTS ix_evidence_chain__evidence_asset_id ON evidence_chain (evidence_asset_id);
-- etl_runs (support table for idempotency/watermark; optional but strongly recommended) CREATE TABLE IF NOT EXISTS etl_runs (  id uuid NOT NULL DEFAULT gen_random_uuid(),  source_system text NOT NULL,  source_object text NOT NULL,  source_checksum text NULL,  started_at timestamptz NOT NULL DEFAULT now(),  finished_at timestamptz NULL,  run_status etl_run_status NOT NULL DEFAULT 'started',  stats jsonb NULL,  created_at timestamptz NOT NULL DEFAULT now(),  created_by text NOT NULL,  updated_at timestamptz NOT NULL DEFAULT now(),  updated_by text NULL,  status record_status NOT NULL DEFAULT 'active',  CONSTRAINT pk_etl_runs PRIMARY KEY (id) );
CREATE INDEX IF NOT EXISTS ix_etl_runssource_system_object ON etl_runs (source_system, source_object); CREATE INDEX IF NOT EXISTS ix_etl_runsrun_status ON etl_runs (run_status);
-- ========================= 
-- UPDATED_AT triggers (explicit) 
-- ========================= DO 
DECLARE  t text;  tables text[] := ARRAY[    'org_units','legal_frameworks','section15_master','national_policies','ems_master_plans',    'strategic_goals','strategic_tactics','external_strategies','governance_bodies','budget_programs',    'programs','projects','fund_sources','project_budget_lines','budget_allocations','financial_transactions',    'budget_revisions','budget_execution_snapshots','locations','activity_types','daily_ops_logs',    'activity_instances','stakeholders','kpis','kpi_targets','kpi_performance','sipoc_processes',    'kpi_sipoc_linkages','evaluation_frameworks','risks','lessons_learned','recommendations',    'unit_cost_models','financial_kpis','audit_records','system_lookups','data_quality_issues',    'result_chains','result_chain_edges','section15_keyword_mapping','strategic_project_section15_alignment',    'evidence_assets','evidence_chain','etl_runs'  ];BEGIN  FOREACH t IN ARRAY tables LOOP    EXECUTE format('DROP TRIGGER IF EXISTS %I ON %I;', 'trg_'||t||'set_updated_at', t);    EXECUTE format('CREATE TRIGGER %I BEFORE UPDATE ON %I FOR EACH ROW EXECUTE FUNCTION fn_set_updated_at();',      'trg_'||t||'set_updated_at', t    );  END LOOP;END

;
COMMIT;
