1) ER Data Diagram — Complete (Mermaid)
Doc ID: docs/04_erd_mermaid.md
Version: 1.0 (Canonical)
Contract Anchors (copy/paste identical in all 6 docs)

DB Contract: db/migrations/0001_init.sql  
Views Contract (MVP10): VW01–VW10 VW01 vw_alignment_traceability  
VW02 vw_kpi_rag_period  
VW03 vw_budget_execution_project  
VW04 vw_evidence_coverage  
VW05 vw_data_quality_heatmap  
VW06 vw_strategic_spine_tree  
VW07 vw_activity_progress_rollup  
VW08 vw_risk_register_project  
VW09 vw_result_chain_paths  
VW10 vw_evidence_compliance_pdpa_ir    
Validation Gates: A (DDL) / B (Views) / C (ETL) / D (period_key) / E (evidence coverage)  


 ERD Block 1/3 — Strategy + Governance + Traceability (VW01, VW06)

จุดประสงค์: “Strategic spine” + “ทองคำของระบบ” (strategic_project_section15_alignment)
ใช้เป็น backbone ของ Trees และทุกการ traceability ในรายงาน/แดชบอร์ด


 
erDiagram  %% ERD BLOCK 1: Strategy & Traceability  %% Supports Views: VW01 (vw_alignment_traceability), VW06 (vw_strategic_spine_tree)  NATIONAL_POLICIES {    uuid id PK    text code "UQ (natural key)"    text name_th  }  EMS_MASTER_PLANS {    uuid id PK    text code "UQ (natural key)"    text name_th    int  period_start    int  period_end    uuid legal_basis_id FK "-> LEGAL_FRAMEWORKS.id (optional)"  }  STRATEGIC_GOALS {    uuid id PK    text code "UQ (natural key)"    text name_th    uuid master_plan_id FK "-> EMS_MASTER_PLANS.id (required)"    uuid national_policy_id FK "-> NATIONAL_POLICIES.id (optional)"  }  STRATEGIC_TACTICS {    uuid id PK    text code "UQ (natural key)"    text name_th    uuid strategic_goal_id FK "-> STRATEGIC_GOALS.id (required)"  }  PROGRAMS {    uuid id PK    text code "UQ (natural key)"    text name_th    uuid strategic_tactic_id FK "-> STRATEGIC_TACTICS.id (required)"    uuid budget_program_id FK "-> BUDGET_PROGRAMS.id (optional; see Block 3)"  }  PROJECTS {    uuid id PK    text code "UQ (natural key)"    text name_th    int  fiscal_year    uuid program_id FK "-> PROGRAMS.id (required)"    uuid strategic_tactic_id FK "-> STRATEGIC_TACTICS.id (optional)"    uuid owner_org_unit_id FK "-> ORG_UNITS.id (optional; transition)"  }  LEGAL_FRAMEWORKS {    uuid id PK    text law_code "UQ (natural key)"    text name_th    text section  }  SECTION15_MASTER {    uuid id PK    int  number "UQ (1-9 within law)"    text name_th    uuid law_id FK "-> LEGAL_FRAMEWORKS.id (required)"  }  KPIS {    uuid id PK    text code "UQ (natural key)"    text name_th    uuid law_link_id FK "-> LEGAL_FRAMEWORKS.id (optional)"    uuid owner_org_unit_id FK "-> ORG_UNITS.id (optional; transition)"  }  STRATEGIC_PROJECT_SECTION15_ALIGNMENT {    uuid id PK    uuid strategic_goal_id FK "-> STRATEGIC_GOALS.id (required)"    uuid tactic_id FK "-> STRATEGIC_TACTICS.id (optional)"    uuid project_id FK "-> PROJECTS.id (required)"    uuid section15_id FK "-> SECTION15_MASTER.id (required)"    uuid kpi_id FK "-> KPIS.id (optional)"    int  weight  }  GOVERNANCE_BODIES {    uuid id PK    text name_th    uuid legal_basis_id FK "-> LEGAL_FRAMEWORKS.id (optional)"  }  EXTERNAL_STRATEGIES {    uuid id PK    text code "UQ (natural key)"    text name_en    text organization  }  ORG_UNITS {    uuid id PK    text code "UQ (natural key)"    text name_th    uuid parent_org_unit_id FK "-> ORG_UNITS.id (optional)"  }  %% Relationships (FK-only)  LEGAL_FRAMEWORKS ||--o{ EMS_MASTER_PLANS : "legal_basis_id"  EMS_MASTER_PLANS  ||--o{ STRATEGIC_GOALS : "master_plan_id"  NATIONAL_POLICIES o|--o{ STRATEGIC_GOALS : "national_policy_id"  STRATEGIC_GOALS   ||--o{ STRATEGIC_TACTICS : "strategic_goal_id"  STRATEGIC_TACTICS ||--o{ PROGRAMS : "strategic_tactic_id"  PROGRAMS          ||--o{ PROJECTS : "program_id"  STRATEGIC_TACTICS o|--o{ PROJECTS : "strategic_tactic_id"  LEGAL_FRAMEWORKS  ||--o{ SECTION15_MASTER : "law_id"  LEGAL_FRAMEWORKS  o|--o{ KPIS : "law_link_id"  STRATEGIC_GOALS   ||--o{ STRATEGIC_PROJECT_SECTION15_ALIGNMENT : "strategic_goal_id"  STRATEGIC_TACTICS o|--o{ STRATEGIC_PROJECT_SECTION15_ALIGNMENT : "tactic_id"  PROJECTS          ||--o{ STRATEGIC_PROJECT_SECTION15_ALIGNMENT : "project_id"  SECTION15_MASTER  ||--o{ STRATEGIC_PROJECT_SECTION15_ALIGNMENT : "section15_id"  KPIS              o|--o{ STRATEGIC_PROJECT_SECTION15_ALIGNMENT : "kpi_id"  LEGAL_FRAMEWORKS  o|--o{ GOVERNANCE_BODIES : "legal_basis_id"  ORG_UNITS         o|--o{ PROJECTS : "owner_org_unit_id"  ORG_UNITS         o|--o{ KPIS : "owner_org_unit_id"  ORG_UNITS         o|--o{ ORG_UNITS : "parent_org_unit_id"


 ERD Block 2/3 — KPI + Targets/Performance + SIPOC + Result Chains (VW02, VW09, VW05)

จุดประสงค์: KPI contract + period_key join + impact-path (result chain edges)
รองรับ RAG, process linkage, และการ “เดินเส้นทางผลลัพธ์” จริง


 
erDiagram  %% ERD BLOCK 2: KPI, SIPOC, Result Chains  %% Supports Views: VW02 (vw_kpi_rag_period), VW09 (vw_result_chain_paths), VW05 (vw_data_quality_heatmap)  KPIS {    uuid id PK    text code "UQ"    text name_th    text kpi_type    uuid owner_org_unit_id FK "-> ORG_UNITS.id (optional; transition)"    uuid law_link_id FK "-> LEGAL_FRAMEWORKS.id (optional)"  }  KPI_TARGETS {    uuid id PK    uuid kpi_id FK "-> KPIS.id (required)"    int  fiscal_year    text period_type    text period_label "legacy display"    text period_key "canonical join key"    numeric target_value    text unit  }  KPI_PERFORMANCE {    uuid id PK    uuid kpi_id FK "-> KPIS.id (required)"    date period_start    date period_end    text period_key "canonical join key"    numeric reported_value    text unit    uuid evidence_set_id FK "-> EVIDENCE_CHAIN.id (optional)"  }  SIPOC_PROCESSES {    uuid id PK    text name_th    text category "S/I/P/O/C"  }  KPI_SIPOC_LINKAGES {    uuid id PK    uuid kpi_id FK "-> KPIS.id (required)"    uuid sipoc_id FK "-> SIPOC_PROCESSES.id (required)"    text process_step  }  RESULT_CHAINS {    uuid id PK    text name_th    text level "input/process/output/outcome/impact"    uuid strategic_goal_id FK "-> STRATEGIC_GOALS.id (optional)"    uuid program_id FK "-> PROGRAMS.id (optional)"  }  RESULT_CHAIN_EDGES {    uuid id PK    uuid parent_node_id FK "-> RESULT_CHAINS.id (required)"    uuid child_node_id  FK "-> RESULT_CHAINS.id (required)"  }  EVALUATION_FRAMEWORKS {    uuid id PK    text name    text dimension  }  DATA_QUALITY_ISSUES {    uuid id PK    text system_name    text issue_type    text description    uuid kpi_id FK "-> KPIS.id (optional)"    uuid daily_id FK "-> DAILY_OPS_LOGS.id (optional; see Block 3)"  }  ORG_UNITS {    uuid id PK    text code "UQ"    text name_th    uuid parent_org_unit_id FK "-> ORG_UNITS.id (optional)"  }  LEGAL_FRAMEWORKS {    uuid id PK    text law_code "UQ"    text name_th  }  %% Relationships (FK-only)  KPIS ||--o{ KPI_TARGETS : "kpi_id"  KPIS ||--o{ KPI_PERFORMANCE : "kpi_id"  KPIS ||--o{ KPI_SIPOC_LINKAGES : "kpi_id"  SIPOC_PROCESSES ||--o{ KPI_SIPOC_LINKAGES : "sipoc_id"  RESULT_CHAINS o|--o{ RESULT_CHAIN_EDGES : "parent_node_id"  RESULT_CHAINS o|--o{ RESULT_CHAIN_EDGES : "child_node_id"  KPIS o|--o{ DATA_QUALITY_ISSUES : "kpi_id"  ORG_UNITS o|--o{ KPIS : "owner_org_unit_id"  LEGAL_FRAMEWORKS o|--o{ KPIS : "law_link_id"  ORG_UNITS o|--o{ ORG_UNITS : "parent_org_unit_id"


 ERD Block 3/3 — Budget + Evidence (first-class) + Ops/Activities + Risk + Location (VW03, VW04, VW07, VW08, VW10)

จุดประสงค์: Budget execution, evidence coverage, ops progress, risk register, compliance
เป็น block ที่ทำให้ “ระบบทำงาน” (ไม่ใช่แค่แผน)


 
erDiagram  %% ERD BLOCK 3: Budget, Evidence, Ops, Risk  %% Supports Views:  %% VW03 (vw_budget_execution_project),  %% VW04 (vw_evidence_coverage),  %% VW07 (vw_activity_progress_rollup),  %% VW08 (vw_risk_register_project),  %% VW10 (vw_evidence_compliance_pdpa_ir)  PROJECTS {    uuid id PK    text code "UQ"    text name_th    int  fiscal_year    uuid program_id FK "-> PROGRAMS.id (required; see Block 1)"    uuid owner_org_unit_id FK "-> ORG_UNITS.id (optional; transition)"  }  BUDGET_PROGRAMS {    uuid id PK    text code "UQ"    text name_th    uuid law_basis_id FK "-> LEGAL_FRAMEWORKS.id (optional)"  }  BUDGET_ALLOCATIONS {    uuid id PK    int  fiscal_year    uuid org_unit_id FK "-> ORG_UNITS.id (optional; transition)"    uuid budget_program_id FK "-> BUDGET_PROGRAMS.id (required)"    uuid project_id FK "-> PROJECTS.id (optional)"    numeric approved_amount  }  FUND_SOURCES {    uuid id PK    text code "UQ"    text name_th  }  PROJECT_BUDGET_LINES {    uuid id PK    uuid project_id FK "-> PROJECTS.id (required)"    text line_code    text line_name    text budget_type    numeric approved_amount    uuid fund_source_id FK "-> FUND_SOURCES.id (optional)"  }  FINANCIAL_TRANSACTIONS {    uuid id PK    uuid project_budget_line_id FK "-> PROJECT_BUDGET_LINES.id (required)"    date transaction_date    numeric amount    text transaction_type    uuid evidence_asset_id FK "-> EVIDENCE_ASSETS.id (optional; preferred)"  }  BUDGET_REVISIONS {    uuid id PK    uuid project_budget_line_id FK "-> PROJECT_BUDGET_LINES.id (required)"    text revision_round    numeric old_amount    numeric new_amount  }  BUDGET_EXECUTION_SNAPSHOTS {    uuid id PK    date snapshot_date    uuid project_id FK "-> PROJECTS.id (required)"    uuid budget_line_id FK "-> PROJECT_BUDGET_LINES.id (optional)"    numeric approved_amount    numeric disbursed_amount    numeric commitment_amount    numeric remaining_amount  }  EVIDENCE_ASSETS {    uuid id PK    text file_url    text checksum_sha256 "UQ (dedup)"    text mime_type    bigint bytes_size    text classification    date retention_until    boolean is_personal_data    uuid owner_org_unit_id FK "-> ORG_UNITS.id (optional; transition)"  }  EVIDENCE_CHAIN {    uuid id PK    uuid evidence_asset_id FK "-> EVIDENCE_ASSETS.id (required; preferred)"    uuid daily_id FK "-> DAILY_OPS_LOGS.id (optional)"    uuid activity_id FK "-> ACTIVITY_INSTANCES.id (optional)"    uuid project_id FK "-> PROJECTS.id (optional)"    uuid kpi_id FK "-> KPIS.id (optional; see Block 2)"    uuid budget_line_id FK "-> PROJECT_BUDGET_LINES.id (optional)"    uuid section15_id FK "-> SECTION15_MASTER.id (optional; see Block 1)"  }  AUDIT_RECORDS {    uuid id PK    uuid project_id FK "-> PROJECTS.id (optional)"    date audit_date    text auditor_org    uuid evidence_asset_id FK "-> EVIDENCE_ASSETS.id (optional; preferred)"  }  ACTIVITY_TYPES {    uuid id PK    text code "UQ"    text name_th  }  ACTIVITY_INSTANCES {    uuid id PK    uuid project_id FK "-> PROJECTS.id (required)"    uuid activity_type_id FK "-> ACTIVITY_TYPES.id (required)"    text name_th    date planned_start    date planned_end    date actual_start    date actual_end    uuid location_id FK "-> LOCATIONS.id (optional)"    uuid daily_id FK "-> DAILY_OPS_LOGS.id (optional)"  }  DAILY_OPS_LOGS {    uuid id PK    date log_date    text title    text description    uuid activity_type_id FK "-> ACTIVITY_TYPES.id (optional)"    uuid org_unit_id FK "-> ORG_UNITS.id (optional; transition)"    uuid location_id FK "-> LOCATIONS.id (optional)"    uuid project_id FK "-> PROJECTS.id (optional)"    uuid kpi_id FK "-> KPIS.id (optional; see Block 2)"    uuid section15_primary_id FK "-> SECTION15_MASTER.id (optional; see Block 1)"  }  RISKS {    uuid id PK    uuid project_id FK "-> PROJECTS.id (optional)"    text description    int likelihood    int impact    int score    uuid related_daily_id FK "-> DAILY_OPS_LOGS.id (optional)"  }  LOCATIONS {    uuid id PK    text code "UQ"    text name_th    text loc_type    uuid parent_location_id FK "-> LOCATIONS.id (optional)"  }  SECTION15_KEYWORD_MAPPING {    uuid id PK    text keyword    uuid section15_id FK "-> SECTION15_MASTER.id (required; see Block 1)"    int weight  }  ORG_UNITS {    uuid id PK    text code "UQ"    text name_th    uuid parent_org_unit_id FK "-> ORG_UNITS.id (optional)"  }  LEGAL_FRAMEWORKS {    uuid id PK    text law_code "UQ"    text name_th  }  %% Relationships (FK-only)  PROJECTS ||--o{ PROJECT_BUDGET_LINES : "project_id"  FUND_SOURCES o|--o{ PROJECT_BUDGET_LINES : "fund_source_id"  PROJECT_BUDGET_LINES ||--o{ FINANCIAL_TRANSACTIONS : "project_budget_line_id"  PROJECT_BUDGET_LINES ||--o{ BUDGET_REVISIONS : "project_budget_line_id"  PROJECTS ||--o{ BUDGET_EXECUTION_SNAPSHOTS : "project_id"  PROJECT_BUDGET_LINES o|--o{ BUDGET_EXECUTION_SNAPSHOTS : "budget_line_id"  BUDGET_PROGRAMS ||--o{ BUDGET_ALLOCATIONS : "budget_program_id"  PROJECTS o|--o{ BUDGET_ALLOCATIONS : "project_id"  ORG_UNITS o|--o{ BUDGET_ALLOCATIONS : "org_unit_id"  LEGAL_FRAMEWORKS o|--o{ BUDGET_PROGRAMS : "law_basis_id"  ORG_UNITS o|--o{ PROJECTS : "owner_org_unit_id"  ORG_UNITS o|--o{ DAILY_OPS_LOGS : "org_unit_id"  ORG_UNITS o|--o{ EVIDENCE_ASSETS : "owner_org_unit_id"  ORG_UNITS o|--o{ ORG_UNITS : "parent_org_unit_id"  EVIDENCE_ASSETS ||--o{ EVIDENCE_CHAIN : "evidence_asset_id"  DAILY_OPS_LOGS o|--o{ EVIDENCE_CHAIN : "daily_id"  ACTIVITY_INSTANCES o|--o{ EVIDENCE_CHAIN : "activity_id"  PROJECTS o|--o{ EVIDENCE_CHAIN : "project_id"  PROJECT_BUDGET_LINES o|--o{ EVIDENCE_CHAIN : "budget_line_id"  EVIDENCE_ASSETS o|--o{ FINANCIAL_TRANSACTIONS : "evidence_asset_id"  EVIDENCE_ASSETS o|--o{ AUDIT_RECORDS : "evidence_asset_id"  PROJECTS o|--o{ AUDIT_RECORDS : "project_id"  PROJECTS ||--o{ ACTIVITY_INSTANCES : "project_id"  ACTIVITY_TYPES ||--o{ ACTIVITY_INSTANCES : "activity_type_id"  DAILY_OPS_LOGS o|--o{ ACTIVITY_INSTANCES : "daily_id"  ACTIVITY_TYPES o|--o{ DAILY_OPS_LOGS : "activity_type_id"  LOCATIONS o|--o{ ACTIVITY_INSTANCES : "location_id"  LOCATIONS o|--o{ DAILY_OPS_LOGS : "location_id"  LOCATIONS o|--o{ LOCATIONS : "parent_location_id"  PROJECTS o|--o{ RISKS : "project_id"  DAILY_OPS_LOGS o|--o{ RISKS : "related_daily_id"


 Cross-Block Consistency Notes 

programs.budget_program_id -> budget_programs.id อยู่ Block 1 (concept) แต่รายละเอียด budget อยู่ Block 3  
daily_ops_logs.kpi_id และ evidence_chain.kpi_id อ้างถึง kpis (Block 2)  
evidence_chain.section15_id และ daily_ops_logs.section15_primary_id อ้างถึง section15_master (Block 1)  
org_units เป็น master dimension ถูกอ้างข้าม block (transition safe)

